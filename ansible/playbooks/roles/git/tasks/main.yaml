- name: Create git directory.
  ansible.builtin.file:
    path: "{{ git_dir }}"
    state: directory
    mode: '0755'

- name: Clone my repositories.
  ansible.builtin.git:
    repo: "git@github.com:theadzik/{{ item }}.git"
    dest: "{{ git_dir }}/{{ item }}"
    update: false
  loop: "{{ repositories }}"

- name: Create .downloads directory.
  ansible.builtin.file:
    path: "{{ downloads_dir }}"
    state: directory
    mode: '0755'

- name: Download ssl_libs packages.
  ansible.builtin.get_url:
    url: http://security.ubuntu.com/ubuntu/pool/main/o/openssl/{{ item }}
    dest: "{{ downloads_dir }}/{{ item }}"
  loop: "{{ ssl_libs }}"
  register: downloaded_ssl_libs

- name: Install ssl_libs packages.
  ansible.builtin.apt:
    deb: "{{ downloads_dir }}/{{ item }}"
  loop: "{{ ssl_libs }}"
  become: true
  when: downloaded_ssl_libs.changed

- name: Check latest git-crypt.
  uri:
    url: https://api.github.com/repos/AGWA/git-crypt/releases/latest
    return_content: true
  register: gitcrypt_latest

- name: Download git-crypt.
  loop: "{{ gitcrypt_latest.json.assets }}"
  loop_control:
    label: "{{ item.name }}"
    break_when: "'linux-x86_64' in item.name"
  when: "'linux-x86_64' in item.name"
  ansible.builtin.get_url:
    url: "{{ item.browser_download_url }}"
    dest: /usr/bin/git-crypt
    mode: "755"
  become: true

- name: Check latest SOPS.
  uri:
    url: https://api.github.com/repos/getsops/sops/releases/latest
    return_content: true
  register: sops_latest

- name: Download SOPS.
  loop: "{{ sops_latest.json.assets }}"
  loop_control:
    label: "{{ item.name }}"
    break_when: "'.linux.amd64' in item.name"
  when: "'.linux.amd64' in item.name"
  ansible.builtin.get_url:
    url: "{{ item.browser_download_url }}"
    dest: /usr/local/bin/sops
    mode: "755"
  become: true

- name: Ensure directory for hashicorp's GPG key is present.
  ansible.builtin.file:
    path: /etc/apt/keyrings
    state: directory
    mode: '0755'

- name: Ensure Hashicorp's official GPG key is added.
  ansible.builtin.apt_key:
    url: https://apt.releases.hashicorp.com/gpg
    keyring: /usr/share/keyrings/hashicorp-archive-keyring.gpg
    state: present
  become: true

- name: Ensure Hashicorp repository is added to apt.
  ansible.builtin.apt_repository:
    repo: >-
      deb [arch={{ arch_mapping[ansible_architecture] | default(ansible_architecture) }}
      signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg]
      https://apt.releases.hashicorp.com {{ ansible_lsb.codename }} main
    filename: docker
    state: present
  become: true

- name: Ensure Hashicorp Vault package is present.
  ansible.builtin.apt:
    name: vault
    state: present
    update_cache: true
  become: true
